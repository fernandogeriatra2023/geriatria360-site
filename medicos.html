<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Área Médica — Geriatria 360</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c5aa0;
      --primary-light: #4a7bc8;
      --secondary: #34a38a;
      --accent: #ff7b54;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #27ae60;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 10px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background-color: #f5f7fa;
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .medical-header {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
    }
    
    .medical-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--primary);
      font-weight: 700;
      font-size: 1.5rem;
    }
    
    .medical-nav {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .medical-nav a {
      text-decoration: none;
      color: var(--dark);
      font-weight: 500;
      transition: var(--transition);
    }
    
    .medical-user {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--gray);
    }
    
    .medical-user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .login-container {
      max-width: 500px;
      margin: 80px auto;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 40px;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
    }
    
    .btn {
      display: inline-block;
      padding: 12px 25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
    }
    
    .btn:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-success:hover {
      background: #219653;
    }
    
    .medical-main {
      display: none;
      padding: 30px 0;
    }
    
    .medical-dashboard {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 30px;
    }
    
    .medical-sidebar {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      height: fit-content;
      position: sticky;
      top: 90px;
    }
    
    .patient-info {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--gray-light);
      margin-bottom: 20px;
    }
    
    .patient-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 15px;
      border: 3px solid var(--primary-light);
    }
    
    .patient-details {
      margin-bottom: 25px;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .detail-label {
      font-weight: 500;
    }
    
    .detail-value {
      color: var(--gray);
    }
    
    .medical-tabs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .medical-tab {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      color: var(--dark);
    }
    
    .medical-tab:hover {
      background: var(--gray-light);
    }
    
    .medical-tab.active {
      background: var(--primary);
      color: white;
    }
    
    .medical-content {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .cid-search-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .cid-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .cid-result {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .cid-result:hover {
      background: var(--gray-light);
    }
    
    .cid-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .cid-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--primary-light);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    .cid-chip button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .editor-toolbar {
      display: flex;
      gap: 5px;
      padding: 10px;
      background: var(--gray-light);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .medical-editor {
      width: 100%;
      min-height: 300px;
      padding: 15px;
      border: 1px solid var(--gray-light);
      border-top: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 1rem;
      resize: vertical;
    }
    
    .medication-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .medication-list {
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    .medication-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 15px;
      padding: 15px;
      border-bottom: 1px solid var(--gray-light);
      align-items: center;
    }
    
    .medication-item:last-child {
      border-bottom: none;
    }
    
    .medication-actions {
      display: flex;
      gap: 10px;
    }
    
    .medication-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
    }
    
    .calendar-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: var(--primary);
      color: white;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .calendar-day {
      padding: 10px;
      text-align: center;
      font-weight: 600;
      background: var(--gray-light);
    }
    
    .calendar-dates {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 60px;
    }
    
    .calendar-date {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .calendar-date.today {
      background: var(--primary-light);
      color: white;
    }
    
    .appointment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      margin-bottom: 15px;
    }
    
    .appointment-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-scheduled {
      background: #e8f4fd;
      color: var(--primary);
    }
    
    .status-confirmed {
      background: #e6f4ea;
      color: var(--success);
    }
    
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .document-card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 20px;
      transition: var(--transition);
    }
    
    .document-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--box-shadow);
    }
    
    .document-icon {
      width: 60px;
      height: 60px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }
    
    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }
    
    .alert-error {
      background: #fde8e6;
      color: var(--danger);
      border: 1px solid #f5b4ab;
    }

    .alert-success {
      background: #e6f4ea;
      color: var(--success);
      border: 1px solid #c8e6c9;
    }
    
    /* Estilos para atestados */
    .cert-field-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .cert-field-full {
      grid-column: 1 / -1;
    }

    /* Estilo para o card de finalização */
    .finalization-card {
      margin-top: 30px;
      background: #e8f5e8;
      border-left: 4px solid var(--success);
      padding: 20px;
      border-radius: var(--border-radius);
    }

    .debug-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 0.8rem;
    }
    
    /* NOVOS ESTILOS PARA AGENDAMENTOS DO DIA */
    .agendamentos-dia-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .agendamentos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .agendamentos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .agendamento-card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 20px;
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }
    
    .agendamento-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--box-shadow);
    }
    
    .agendamento-card.prioridade-alta {
      border-left-color: var(--danger);
    }
    
    .agendamento-card.prioridade-media {
      border-left-color: var(--warning);
    }
    
    .agendamento-card.prioridade-baixa {
      border-left-color: var(--success);
    }
    
    .agendamento-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .agendamento-actions .btn {
      padding: 8px 15px;
      font-size: 0.9rem;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .badge-primary {
      background: var(--primary-light);
      color: white;
    }
    
    .badge-warning {
      background: var(--warning);
      color: white;
    }
    
    .badge-success {
      background: var(--success);
      color: white;
    }
    
    .badge-danger {
      background: var(--danger);
      color: white;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--gray-light);
    }
    
    @media (max-width: 1200px) {
      .medical-dashboard {
        grid-template-columns: 1fr;
      }
      
      .medical-sidebar {
        position: static;
      }
    }
    
    @media (max-width: 768px) {
      .medical-nav {
        display: none;
      }
      
      .medication-form {
        grid-template-columns: 1fr;
      }
      
      .medication-item {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .documents-grid {
        grid-template-columns: 1fr;
      }
      
      .cert-field-group {
        grid-template-columns: 1fr;
      }
      
      .agendamentos-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="medical-header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="medical-brand">
          <i class="fas fa-heartbeat"></i>
          <span>Geriatria 360</span>
        </a>
        
        <nav class="medical-nav">
          <a href="index.html"><i class="fas fa-home"></i> Início</a>
          <a href="recepcao.html"><i class="fas fa-user-injured"></i> Recepção</a>
          <a href="triagem.html"><i class="fas fa-stethoscope"></i> Triagem</a>
        </nav>
        
        <div class="medical-user">
          <img src="https://ui-avatars.com/api/?name=Dr+Silva&background=2c5aa0&color=fff" alt="Dr. Silva">
          <div>
            <div>Dr. Silva</div>
            <small>Geriatra</small>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section id="loginArea" class="login-container">
    <div class="login-header">
      <h1>Área Médica</h1>
      <p>Acesso restrito a profissionais de saúde</p>
    </div>
    
    <form id="loginForm">
      <div class="form-group">
        <label for="med-user">CRM</label>
        <input type="text" id="med-user" class="form-control" placeholder="Digite seu CRM">
      </div>
      
      <div class="form-group">
        <label for="med-pass">Senha</label>
        <input type="password" id="med-pass" class="form-control" placeholder="Digite sua senha">
      </div>
      
      <button type="button" class="btn btn-block" onclick="loginMed()">Entrar na Área Médica</button>
    </form>
    
    <div class="alert alert-error" id="loginError" style="display: none;">
      CRM ou senha incorretos. Tente novamente.
    </div>

    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: var(--border-radius);">
      <p><strong>Credenciais de Teste:</strong></p>
      <p>CRM: <strong>123456</strong></p>
      <p>Senha: <strong>medico123</strong></p>
    </div>
  </section>

  <section id="medicalArea" class="medical-main">
    <div class="container">
      <div class="medical-dashboard">
        <aside class="medical-sidebar">
          <div class="patient-info">
            <img src="https://ui-avatars.com/api/?name=Médico&background=2c5aa0&color=fff" alt="Médico" class="patient-avatar">
            <h3 id="medicName">Dr. Silva</h3>
            <p>CRM: <strong>123456</strong></p>
          </div>
          
          <div class="patient-details">
            <div class="detail-item">
              <span class="detail-label">Agendamentos Hoje</span>
              <span class="detail-value" id="agendamentosCount">0</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Em Atendimento</span>
              <span class="detail-value" id="atendimentosCount">0</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Finalizados</span>
              <span class="detail-value" id="finalizadosCount">0</span>
            </div>
          </div>
          
          <div class="medical-tabs">
            <a href="#" class="medical-tab active" data-tab="dashboard">
              <i class="fas fa-home"></i>
              <span>Dashboard</span>
            </a>
            <a href="#" class="medical-tab" data-tab="evolucao">
              <i class="fas fa-stethoscope"></i>
              <span>Evolução Médica</span>
            </a>
            <a href="#" class="medical-tab" data-tab="medicacao">
              <i class="fas fa-pills"></i>
              <span>Medicação</span>
            </a>
            <a href="#" class="medical-tab" data-tab="atestados">
              <i class="fas fa-file-medical"></i>
              <span>Atestados</span>
            </a>
            <a href="#" class="medical-tab" data-tab="documentos">
              <i class="fas fa-file-contract"></i>
              <span>Documentos</span>
            </a>
            <a href="#" class="medical-tab" data-tab="agendamento">
              <i class="fas fa-calendar-check"></i>
              <span>Agendamento</span>
            </a>
            <a href="#" class="medical-tab" data-tab="exames">
              <i class="fas fa-vial"></i>
              <span>Solicitar Exames</span>
            </a>
          </div>
        </aside>
        
        <main class="medical-content">
          <!-- Dashboard -->
          <div id="dashboard" class="tab-content active">
            <div class="tab-header">
              <h2>Dashboard Médico</h2>
              <div class="tab-actions">
                <button class="btn" onclick="carregarAgendamentosDoDia()">
                  <i class="fas fa-sync-alt"></i> Atualizar
                </button>
              </div>
            </div>
            
            <div class="agendamentos-dia-container">
              <div class="agendamentos-header">
                <h3><i class="fas fa-calendar-day"></i> Agendamentos de Hoje</h3>
                <span class="badge badge-primary" id="totalAgendamentosHoje">0 agendamentos</span>
              </div>
              
              <div id="agendamentosDoDia" class="agendamentos-grid">
                <!-- Agendamentos serão carregados aqui -->
              </div>
            </div>
            
            <div class="agendamentos-dia-container">
              <div class="agendamentos-header">
                <h3><i class="fas fa-user-injured"></i> Pacientes em Atendimento</h3>
                <span class="badge badge-warning" id="totalAtendimentos">0 pacientes</span>
              </div>
              
              <div id="pacientesAtendimento" class="agendamentos-grid">
                <!-- Pacientes em atendimento serão carregados aqui -->
              </div>
            </div>
          </div>
          
          <!-- Evolução Médica -->
          <div id="evolucao" class="tab-content">
            <div class="tab-header">
              <h2>Evolução Médica</h2>
              <div class="tab-actions">
                <button class="btn" onclick="saveEvolution()"><i class="fas fa-save"></i> Salvar</button>
                <button class="btn btn-success" onclick="generateAIReport()"><i class="fas fa-robot"></i> Gerar Laudo IA</button>
              </div>
            </div>
            
            <div id="pacienteInfoEvolucao" style="background: #e8f4fd; padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; display: none;">
              <h4 id="nomePacienteEvolucao"></h4>
              <p id="detalhesPacienteEvolucao"></p>
            </div>
            
            <div class="alert alert-error" id="alertNoPatient" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i> Nenhum paciente selecionado. Selecione um paciente na aba "Dashboard" para iniciar o atendimento.
            </div>
            
            <div class="cid-search-container">
              <input type="text" id="cidSearch" class="form-control" placeholder="Digite código CID-10 (ex: I10) ou descrição...">
              <div id="cidResults" class="cid-results"></div>
            </div>
            
            <div id="cidChips" class="cid-chips"></div>
            
            <div class="editor-container">
              <div class="editor-toolbar">
                <button type="button" title="Negrito" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                <button type="button" title="Itálico" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                <button type="button" title="Sublinhado" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                <button type="button" title="Lista" onclick="formatText('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                <button type="button" title="Lista Numerada" onclick="formatText('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
              </div>
              <div id="evolText" class="medical-editor" contenteditable="true">
                <p><strong>Queixa Principal:</strong> </p>
                <p><strong>História da Doença Atual:</strong> </p>
                <p><strong>Exame Físico:</strong> </p>
                <p><strong>Conduta:</strong> </p>
              </div>
            </div>
            
            <!-- Finalizar Atendimento -->
            <div class="finalization-card" id="finalizationCard" style="display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="color: var(--success); margin-bottom: 5px;">
                    <i class="fas fa-check-circle"></i> Finalizar Atendimento
                  </h3>
                  <p style="color: var(--gray); margin: 0;" id="statusPaciente">
                    Pronto para finalizar atendimento
                  </p>
                </div>
                <button class="btn btn-success" onclick="finalizarAtendimento()" style="font-size: 1.1rem;">
                  <i class="fas fa-flag-checkered"></i> Finalizar Atendimento
                </button>
              </div>
            </div>
          </div>
          
          <!-- As outras abas (Medicação, Atestados, Documentos, Agendamento, Exames) permanecem iguais -->
          <!-- Medicação -->
          <div id="medicacao" class="tab-content">
            <!-- ... conteúdo existente ... -->
          </div>
          
          <!-- Atestados -->
          <div id="atestados" class="tab-content">
            <!-- ... conteúdo existente ... -->
          </div>
          
          <!-- Documentos -->
          <div id="documentos" class="tab-content">
            <!-- ... conteúdo existente ... -->
          </div>
          
          <!-- Agendamento -->
          <div id="agendamento" class="tab-content">
            <!-- ... conteúdo existente ... -->
          </div>
          
          <!-- Solicitar Exames -->
          <div id="exames" class="tab-content">
            <!-- ... conteúdo existente ... -->
          </div>

          <!-- Painel de Debug -->
          <div class="debug-panel">
            <h4>🔧 Debug do Sistema</h4>
            <button class="btn" onclick="debugSistema()" style="padding: 5px 10px; font-size: 0.8rem; margin-bottom: 10px;">
              <i class="fas fa-bug"></i> Verificar Dados
            </button>
            <div id="debugOutput"></div>
          </div>
        </main>
      </div>
    </div>
  </section>

  <script>
    // ===== SISTEMA PRINCIPAL =====
    let currentAppointment = null;
    let medications = [];
    let exams = [];
    let appointments = [];
    let selectedCids = [];
    let selectedCidsAtestado = [];
    
    // Base de dados de CID-10
    const cidData = [
      { code: "A00", description: "Cólera" },
      { code: "A01", description: "Febres tifóide e paratifóide" },
      { code: "A02", description: "Outras infecções por Salmonella" },
      { code: "I10", description: "Hipertensão essencial (primária)" },
      { code: "I11", description: "Doença cardíaca hipertensiva" },
      { code: "I20", description: "Angina pectoris" },
      { code: "I21", description: "Infarto agudo do miocárdio" },
      { code: "I25", description: "Doença isquêmica crônica do coração" },
      { code: "E10", description: "Diabetes mellitus insulinodependente" },
      { code: "E11", description: "Diabetes mellitus não-insulinodependente" },
      { code: "E66", description: "Obesidade" },
      { code: "F00", description: "Demência na doença de Alzheimer" },
      { code: "F01", description: "Demência vascular" },
      { code: "F03", description: "Demência não especificada" },
      { code: "F10", description: "Transtornos mentais devido ao uso de álcool" },
      { code: "G20", description: "Doença de Parkinson" },
      { code: "G30", description: "Doença de Alzheimer" },
      { code: "J45", description: "Asma" },
      { code: "J44", description: "Outras doenças pulmonares obstrutivas crônicas" },
      { code: "M15", description: "Poliartrose" },
      { code: "M16", description: "Coxartrose (artrose do quadril)" },
      { code: "M17", description: "Gonartrose (artrose do joelho)" },
      { code: "M19", description: "Outras artroses" },
      { code: "N18", description: "Doença renal crônica" },
      { code: "N39", description: "Outros transtornos do sistema urinário" },
      { code: "R05", description: "Tosse" },
      { code: "R06", description: "Anormalidades da respiração" },
      { code: "R53", description: "Mal-estar e fadiga" },
      { code: "Z00", description: "Exame geral de rotina" }
    ];
    
    // Login
    function loginMed() {
      const user = document.getElementById('med-user').value;
      const pass = document.getElementById('med-pass').value;
      
      if (user === '123456' && pass === 'medico123') {
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('medicalArea').style.display = 'block';
        initCIDSearch();
        initCalendar();
        setupTabNavigation();
        
        // Carregar dashboard com agendamentos do dia
        carregarAgendamentosDoDia();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    // Navegação por abas
    function setupTabNavigation() {
      const tabs = document.querySelectorAll('.medical-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remover classe active de todas as abas
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Adicionar classe active à aba clicada
          this.classList.add('active');
          
          // Mostrar conteúdo correspondente
          const tabId = this.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
          
          // Se for a aba de evolução, verificar se há paciente selecionado
          if (tabId === 'evolucao') {
            verificarPacienteSelecionado();
          }
        });
      });
    }
    
    // Carregar agendamentos do dia
    function carregarAgendamentosDoDia() {
      const hoje = new Date().toISOString().split('T')[0];
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      
      // Filtrar agendamentos de hoje
      const agendamentosHoje = agendamentos.filter(ag => ag.data === hoje && ag.status !== 'finalizado');
      
      // Atualizar contadores
      document.getElementById('agendamentosCount').textContent = agendamentosHoje.length;
      document.getElementById('totalAgendamentosHoje').textContent = `${agendamentosHoje.length} agendamentos`;
      
      const emAtendimento = agendamentosHoje.filter(ag => ag.status === 'em_atendimento').length;
      document.getElementById('atendimentosCount').textContent = emAtendimento;
      document.getElementById('totalAtendimentos').textContent = `${emAtendimento} pacientes`;
      
      // Renderizar agendamentos
      const container = document.getElementById('agendamentosDoDia');
      
      if (agendamentosHoje.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h3>Nenhum agendamento para hoje</h3>
            <p>Não há consultas agendadas para o dia de hoje.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      agendamentosHoje.forEach(agendamento => {
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        const triagem = triagens.find(t => t.agendamentoId === agendamento.id);
        
        const card = document.createElement('div');
        card.className = `agendamento-card ${triagem ? `prioridade-${triagem.prioridade}` : ''}`;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <h4>${agendamento.pacienteNome || paciente.nome || 'Paciente'}</h4>
            <span class="badge ${getStatusBadgeClass(agendamento.status)}">${getStatusText(agendamento.status)}</span>
          </div>
          <p><i class="fas fa-clock"></i> ${agendamento.hora}</p>
          <p><i class="fas fa-user-md"></i> ${agendamento.medico || 'Dr. Silva'}</p>
          ${triagem ? `<p><i class="fas fa-thermometer-half"></i> Prioridade: <strong>${triagem.prioridade}</strong></p>` : ''}
          ${triagem ? `<p><i class="fas fa-heartbeat"></i> PA: ${triagem.pressaoSistolica}/${triagem.pressaoDiastolica} | FC: ${triagem.batimentosCardiacos}</p>` : ''}
          <div class="agendamento-actions">
            ${agendamento.status === 'agendado' ? `<button class="btn" onclick="iniciarAtendimento('${agendamento.id}')"><i class="fas fa-play"></i> Iniciar</button>` : ''}
            ${agendamento.status === 'em_atendimento' ? `<button class="btn btn-success" onclick="continuarAtendimento('${agendamento.id}')"><i class="fas fa-stethoscope"></i> Continuar</button>` : ''}
            <button class="btn" onclick="verDetalhesAgendamento('${agendamento.id}')"><i class="fas fa-info-circle"></i> Detalhes</button>
          </div>
        `;
        
        container.appendChild(card);
      });
      
      // Carregar pacientes em atendimento
      carregarPacientesEmAtendimento();
    }
    
    // Carregar pacientes em atendimento
    function carregarPacientesEmAtendimento() {
      const hoje = new Date().toISOString().split('T')[0];
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      
      const emAtendimento = agendamentos.filter(ag => ag.data === hoje && ag.status === 'em_atendimento');
      
      const container = document.getElementById('pacientesAtendimento');
      
      if (emAtendimento.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-user-clock"></i>
            <h3>Nenhum paciente em atendimento</h3>
            <p>Inicie um atendimento para ver os pacientes aqui.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      emAtendimento.forEach(agendamento => {
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        
        const card = document.createElement('div');
        card.className = 'agendamento-card prioridade-alta';
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <h4>${agendamento.pacienteNome || paciente.nome || 'Paciente'}</h4>
            <span class="badge badge-warning">Em Atendimento</span>
          </div>
          <p><i class="fas fa-clock"></i> ${agendamento.hora}</p>
          <p><i class="fas fa-user-md"></i> ${agendamento.medico || 'Dr. Silva'}</p>
          <div class="agendamento-actions">
            <button class="btn btn-success" onclick="continuarAtendimento('${agendamento.id}')"><i class="fas fa-stethoscope"></i> Continuar</button>
            <button class="btn" onclick="verDetalhesAgendamento('${agendamento.id}')"><i class="fas fa-info-circle"></i> Detalhes</button>
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Iniciar atendimento
    function iniciarAtendimento(agendamentoId) {
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      
      const agendamentoIndex = agendamentos.findIndex(ag => ag.id === agendamentoId);
      
      if (agendamentoIndex !== -1) {
        // Atualizar status do agendamento
        agendamentos[agendamentoIndex].status = 'em_atendimento';
        localStorage.setItem('geriatria_agendamentos', JSON.stringify(agendamentos));
        
        // Carregar dados do paciente
        const agendamento = agendamentos[agendamentoIndex];
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        const triagem = triagens.find(t => t.agendamentoId === agendamentoId);
        
        currentAppointment = {
          id: agendamento.id,
          pacienteId: agendamento.pacienteId,
          pacienteNome: agendamento.pacienteNome || paciente.nome,
          pacienteCPF: agendamento.pacienteCPF || paciente.cpf,
          medico: agendamento.medico,
          data: agendamento.data,
          hora: agendamento.hora,
          status: 'em_atendimento',
          paciente: paciente,
          triagem: triagem
        };
        
        // Mostrar sucesso
        showAlert(`Atendimento iniciado para <strong>${currentAppointment.pacienteNome}</strong>`, 'success');
        
        // Atualizar dashboard
        carregarAgendamentosDoDia();
        
        // Mudar para aba de evolução
        document.querySelector('.medical-tab[data-tab="evolucao"]').click();
        
        // Atualizar interface do paciente
        atualizarInterfacePaciente();
      }
    }
    
    // Continuar atendimento
    function continuarAtendimento(agendamentoId) {
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      
      const agendamento = agendamentos.find(ag => ag.id === agendamentoId);
      
      if (agendamento) {
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        const triagem = triagens.find(t => t.agendamentoId === agendamentoId);
        
        currentAppointment = {
          id: agendamento.id,
          pacienteId: agendamento.pacienteId,
          pacienteNome: agendamento.pacienteNome || paciente.nome,
          pacienteCPF: agendamento.pacienteCPF || paciente.cpf,
          medico: agendamento.medico,
          data: agendamento.data,
          hora: agendamento.hora,
          status: agendamento.status,
          paciente: paciente,
          triagem: triagem
        };
        
        // Mudar para aba de evolução
        document.querySelector('.medical-tab[data-tab="evolucao"]').click();
        
        // Atualizar interface do paciente
        atualizarInterfacePaciente();
      }
    }
    
    // Atualizar interface do paciente
    function atualizarInterfacePaciente() {
      if (currentAppointment) {
        // Mostrar informações do paciente
        document.getElementById('pacienteInfoEvolucao').style.display = 'block';
        document.getElementById('nomePacienteEvolucao').textContent = currentAppointment.pacienteNome;
        
        let detalhes = `ID: ${currentAppointment.pacienteId} | CPF: ${formatCPF(currentAppointment.pacienteCPF)}`;
        if (currentAppointment.triagem) {
          detalhes += ` | Prioridade: ${currentAppointment.triagem.prioridade} | PA: ${currentAppointment.triagem.pressaoSistolica}/${currentAppointment.triagem.pressaoDiastolica}`;
        }
        
        document.getElementById('detalhesPacienteEvolucao').textContent = detalhes;
        
        // Mostrar card de finalização
        document.getElementById('finalizationCard').style.display = 'block';
        
        // Esconder alerta de nenhum paciente
        document.getElementById('alertNoPatient').style.display = 'none';
        
        // Carregar dados da triagem no editor, se existirem
        if (currentAppointment.triagem) {
          carregarDadosTriagem();
        }
      }
    }
    
    // Carregar dados da triagem no editor
    function carregarDadosTriagem() {
      if (!currentAppointment || !currentAppointment.triagem) return;
      
      const triagem = currentAppointment.triagem;
      let triagemHTML = `
        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
          <p style="margin: 0 0 10px 0;"><strong>📋 DADOS DA TRIAGEM:</strong></p>
          <p style="margin: 5px 0;"><strong>Queixa Principal:</strong> ${triagem.queixaPrincipal}</p>
          <p style="margin: 5px 0;"><strong>Sinais Vitais:</strong> PA ${triagem.pressaoSistolica}/${triagem.pressaoDiastolica} | FC ${triagem.batimentosCardiacos} bpm | Temp ${triagem.temperatura}°C | Sat O₂ ${triagem.saturacaoOxigenio}%</p>
          <p style="margin: 5px 0;"><strong>Antropometria:</strong> Peso ${triagem.peso}kg | Altura ${triagem.altura}m | IMC ${triagem.imc}</p>
          ${triagem.glicemia ? `<p style="margin: 5px 0;"><strong>Glicemia:</strong> ${triagem.glicemia} mg/dL</p>` : ''}
          ${triagem.observacoes ? `<p style="margin: 5px 0;"><strong>Observações da Triagem:</strong> ${triagem.observacoes}</p>` : ''}
          <p style="margin: 5px 0;"><strong>Prioridade:</strong> <span style="color: ${getPriorityColor(triagem.prioridade)}; font-weight: bold;">${triagem.prioridade.toUpperCase()}</span></p>
        </div>
        <hr>
      `;
      
      const evolText = document.getElementById('evolText');
      evolText.innerHTML = triagemHTML + evolText.innerHTML;
    }
    
    // Verificar se há paciente selecionado na aba de evolução
    function verificarPacienteSelecionado() {
      if (!currentAppointment) {
        document.getElementById('alertNoPatient').style.display = 'block';
        document.getElementById('finalizationCard').style.display = 'none';
        document.getElementById('pacienteInfoEvolucao').style.display = 'none';
      } else {
        document.getElementById('alertNoPatient').style.display = 'none';
        document.getElementById('finalizationCard').style.display = 'block';
        document.getElementById('pacienteInfoEvolucao').style.display = 'block';
      }
    }
    
    // Finalizar atendimento
    function finalizarAtendimento() {
      if (!currentAppointment) {
        showAlert('Nenhum paciente em atendimento para finalizar.', 'error');
        return;
      }
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const agendamentoIndex = agendamentos.findIndex(ag => ag.id === currentAppointment.id);
      
      if (agendamentoIndex !== -1) {
        // Atualizar status do agendamento
        agendamentos[agendamentoIndex].status = 'finalizado';
        agendamentos[agendamentoIndex].dataFinalizacao = new Date().toISOString();
        localStorage.setItem('geriatria_agendamentos', JSON.stringify(agendamentos));
        
        // Salvar prontuário
        salvarProntuarioCompleto();
        
        showAlert(`Atendimento de <strong>${currentAppointment.pacienteNome}</strong> finalizado com sucesso!`, 'success');
        
        // Limpar dados do atendimento atual
        currentAppointment = null;
        
        // Atualizar dashboard
        carregarAgendamentosDoDia();
        
        // Voltar para o dashboard
        document.querySelector('.medical-tab[data-tab="dashboard"]').click();
        
        // Limpar editor
        document.getElementById('evolText').innerHTML = `
          <p><strong>Queixa Principal:</strong> </p>
          <p><strong>História da Doença Atual:</strong> </p>
          <p><strong>Exame Físico:</strong> </p>
          <p><strong>Conduta:</strong> </p>
        `;
      }
    }
    
    // Salvar prontuário completo
    function salvarProntuarioCompleto() {
      if (!currentAppointment) return;
      
      const prontuario = {
        id: Date.now(),
        agendamentoId: currentAppointment.id,
        pacienteId: currentAppointment.pacienteId,
        pacienteNome: currentAppointment.pacienteNome,
        pacienteCPF: currentAppointment.pacienteCPF,
        medico: currentAppointment.medico,
        dataAtendimento: new Date().toISOString(),
        evolucao: document.getElementById('evolText').innerHTML,
        medicamentos: medications,
        exames: exams,
        diagnosticos: selectedCids,
        observacoes: "Atendimento finalizado pelo sistema"
      };
      
      // Salvar no localStorage
      const prontuarios = JSON.parse(localStorage.getItem('geriatria_prontuarios')) || [];
      prontuarios.push(prontuario);
      localStorage.setItem('geriatria_prontuarios', JSON.stringify(prontuarios));
    }
    
    // Funções auxiliares
    function getStatusBadgeClass(status) {
      switch(status) {
        case 'agendado': return 'badge-primary';
        case 'em_atendimento': return 'badge-warning';
        case 'finalizado': return 'badge-success';
        default: return 'badge-primary';
      }
    }
    
    function getStatusText(status) {
      switch(status) {
        case 'agendado': return 'Agendado';
        case 'em_atendimento': return 'Em Atendimento';
        case 'finalizado': return 'Finalizado';
        default: return status;
      }
    }
    
    function getPriorityColor(prioridade) {
      switch(prioridade) {
        case 'alta': return '#e74c3c';
        case 'media': return '#f39c12';
        case 'baixa': return '#27ae60';
        default: return '#6c757d';
      }
    }
    
    function formatCPF(cpf) {
      if (!cpf) return 'Não informado';
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length !== 11) return cpf;
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }
    
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = message;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '100px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
    
    // Funções para ver detalhes do agendamento (placeholder)
    function verDetalhesAgendamento(agendamentoId) {
      showAlert('Funcionalidade de detalhes em desenvolvimento', 'success');
    }
    
    // ===== FUNÇÕES EXISTENTES (mantidas para compatibilidade) =====
    
    // Busca de CID para evolução
    function initCIDSearch() {
      const cidSearch = document.getElementById('cidSearch');
      const cidResults = document.getElementById('cidResults');
      
      cidSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        
        if (query.length < 2) {
          cidResults.style.display = 'none';
          return;
        }
        
        const filtered = cidData.filter(item => 
          item.code.toLowerCase().includes(query) || 
          item.description.toLowerCase().includes(query)
        );
        
        displayCIDResults(filtered);
      });
      
      // Fechar resultados ao clicar fora
      document.addEventListener('click', function(e) {
        if (!cidSearch.contains(e.target) && !cidResults.contains(e.target)) {
          cidResults.style.display = 'none';
        }
      });
    }
    
    function displayCIDResults(results) {
      const cidResults = document.getElementById('cidResults');
      cidResults.innerHTML = '';
      
      if (results.length === 0) {
        cidResults.innerHTML = '<div class="cid-result">Nenhum resultado encontrado</div>';
      } else {
        results.forEach(item => {
          const div = document.createElement('div');
          div.className = 'cid-result';
          div.innerHTML = `<strong>${item.code}</strong> - ${item.description}`;
          div.addEventListener('click', () => selectCID(item));
          cidResults.appendChild(div);
        });
      }
      
      cidResults.style.display = 'block';
    }
    
    function selectCID(cid) {
      if (!selectedCids.find(item => item.code === cid.code)) {
        selectedCids.push(cid);
        updateCIDChips();
      }
      
      document.getElementById('cidSearch').value = '';
      document.getElementById('cidResults').style.display = 'none';
    }
    
    function updateCIDChips() {
      const container = document.getElementById('cidChips');
      container.innerHTML = '';
      
      selectedCids.forEach(cid => {
        const chip = document.createElement('div');
        chip.className = 'cid-chip';
        chip.innerHTML = `
          ${cid.code} - ${cid.description}
          <button onclick="removeCID('${cid.code}')"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(chip);
      });
    }
    
    function removeCID(code) {
      selectedCids = selectedCids.filter(item => item.code !== code);
      updateCIDChips();
    }
    
    // Formatação de texto no editor
    function formatText(command) {
      document.execCommand(command, false, null);
      document.getElementById('evolText').focus();
    }
    
    // Calendário
    let currentDate = new Date();
    
    function initCalendar() {
      updateCalendar();
    }
    
    function updateCalendar() {
      // Implementação do calendário (mantida do código original)
    }
    
    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      updateCalendar();
    }
    
    // Funções de debug
    function debugSistema() {
      const debugOutput = document.getElementById('debugOutput');
      let output = '<strong>=== DEBUG DO SISTEMA ===</strong><br>';
      
      output += `<strong>🩺 Current Appointment:</strong> ${JSON.stringify(currentAppointment, null, 2)}<br><br>`;
      
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes') || '[]');
      output += `<strong>👥 Pacientes (${pacientes.length}):</strong> ${JSON.stringify(pacientes, null, 2)}<br><br>`;
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos') || '[]');
      output += `<strong>📅 Agendamentos (${agendamentos.length}):</strong> ${JSON.stringify(agendamentos, null, 2)}<br><br>`;
      
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens') || '[]');
      output += `<strong>📊 Triagens (${triagens.length}):</strong> ${JSON.stringify(triagens, null, 2)}<br><br>`;
      
      debugOutput.innerHTML = output;
      
      // Também logar no console
      console.log('=== DEBUG DO SISTEMA ===');
      console.log('Current Appointment:', currentAppointment);
      console.log('Pacientes:', pacientes);
      console.log('Agendamentos:', agendamentos);
      console.log('Triagens:', triagens);
    }
    
    // Outras funções (placeholders)
    function saveEvolution() {
      showAlert('Evolução salva com sucesso!', 'success');
    }
    
    function generateAIReport() {
      showAlert('Laudo gerado pela IA com base nas informações fornecidas!', 'success');
    }
  </script>
</body>
</html>
