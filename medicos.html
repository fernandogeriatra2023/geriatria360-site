<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Área Médica — Geriatria 360</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2c5aa0;
      --primary-light: #4a7bc8;
      --secondary: #34a38a;
      --accent: #ff7b54;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #27ae60;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 10px;
      --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background-color: #f5f7fa;
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .medical-header {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
    }
    
    .medical-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--primary);
      font-weight: 700;
      font-size: 1.5rem;
    }
    
    .medical-nav {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .medical-nav a {
      text-decoration: none;
      color: var(--dark);
      font-weight: 500;
      transition: var(--transition);
    }
    
    .medical-user {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--gray);
    }
    
    .medical-user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .login-container {
      max-width: 500px;
      margin: 80px auto;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 40px;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
    }
    
    .btn {
      display: inline-block;
      padding: 12px 25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
    }
    
    .btn:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    .btn-success {
      background: var(--success);
    }
    
    .btn-success:hover {
      background: #219653;
    }
    
    .medical-main {
      display: none;
      padding: 30px 0;
    }
    
    .medical-dashboard {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 30px;
    }
    
    .medical-sidebar {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      height: fit-content;
      position: sticky;
      top: 90px;
    }
    
    .patient-info {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--gray-light);
      margin-bottom: 20px;
    }
    
    .patient-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 15px;
      border: 3px solid var(--primary-light);
    }
    
    .patient-details {
      margin-bottom: 25px;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .detail-label {
      font-weight: 500;
    }
    
    .detail-value {
      color: var(--gray);
    }
    
    .medical-tabs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .medical-tab {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      color: var(--dark);
    }
    
    .medical-tab:hover {
      background: var(--gray-light);
    }
    
    .medical-tab.active {
      background: var(--primary);
      color: white;
    }
    
    .medical-content {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .cid-search-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .cid-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    
    .cid-result {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .cid-result:hover {
      background: var(--gray-light);
    }
    
    .cid-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .cid-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--primary-light);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    .cid-chip button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .editor-toolbar {
      display: flex;
      gap: 5px;
      padding: 10px;
      background: var(--gray-light);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .medical-editor {
      width: 100%;
      min-height: 300px;
      padding: 15px;
      border: 1px solid var(--gray-light);
      border-top: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 1rem;
      resize: vertical;
    }
    
    .medication-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .medication-list {
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    .medication-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 15px;
      padding: 15px;
      border-bottom: 1px solid var(--gray-light);
      align-items: center;
    }
    
    .medication-item:last-child {
      border-bottom: none;
    }
    
    .medication-actions {
      display: flex;
      gap: 10px;
    }
    
    .medication-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
    }
    
    .calendar-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: var(--primary);
      color: white;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .calendar-day {
      padding: 10px;
      text-align: center;
      font-weight: 600;
      background: var(--gray-light);
    }
    
    .calendar-dates {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 60px;
    }
    
    .calendar-date {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .calendar-date.today {
      background: var(--primary-light);
      color: white;
    }
    
    .appointment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      margin-bottom: 15px;
    }
    
    .appointment-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .status-scheduled {
      background: #e8f4fd;
      color: var(--primary);
    }
    
    .status-confirmed {
      background: #e6f4ea;
      color: var(--success);
    }
    
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .document-card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 20px;
      transition: var(--transition);
    }
    
    .document-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--box-shadow);
    }
    
    .document-icon {
      width: 60px;
      height: 60px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      margin-bottom: 15px;
    }
    
    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
    }
    
    .alert-error {
      background: #fde8e6;
      color: var(--danger);
      border: 1px solid #f5b4ab;
    }

    .alert-success {
      background: #e6f4ea;
      color: var(--success);
      border: 1px solid #c8e6c9;
    }
    
    /* Estilos para atestados */
    .cert-field-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .cert-field-full {
      grid-column: 1 / -1;
    }

    /* Estilo para o card de finalização */
    .finalization-card {
      margin-top: 30px;
      background: #e8f5e8;
      border-left: 4px solid var(--success);
      padding: 20px;
      border-radius: var(--border-radius);
    }

    .debug-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 0.8rem;
    }
    
    /* NOVOS ESTILOS PARA AGENDAMENTOS DO DIA */
    .agendamentos-dia-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .agendamentos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .agendamentos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .agendamento-card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 20px;
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }
    
    .agendamento-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--box-shadow);
    }
    
    .agendamento-card.prioridade-alta {
      border-left-color: var(--danger);
    }
    
    .agendamento-card.prioridade-media {
      border-left-color: var(--warning);
    }
    
    .agendamento-card.prioridade-baixa {
      border-left-color: var(--success);
    }
    
    .agendamento-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .agendamento-actions .btn {
      padding: 8px 15px;
      font-size: 0.9rem;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .badge-primary {
      background: var(--primary-light);
      color: white;
    }
    
    .badge-warning {
      background: var(--warning);
      color: white;
    }
    
    .badge-success {
      background: var(--success);
      color: white;
    }
    
    .badge-danger {
      background: var(--danger);
      color: white;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--gray-light);
    }
    
    .no-patient-alert {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      text-align: center;
    }
    
    @media (max-width: 1200px) {
      .medical-dashboard {
        grid-template-columns: 1fr;
      }
      
      .medical-sidebar {
        position: static;
      }
    }
    
    @media (max-width: 768px) {
      .medical-nav {
        display: none;
      }
      
      .medication-form {
        grid-template-columns: 1fr;
      }
      
      .medication-item {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .documents-grid {
        grid-template-columns: 1fr;
      }
      
      .cert-field-group {
        grid-template-columns: 1fr;
      }
      
      .agendamentos-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="medical-header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="medical-brand">
          <i class="fas fa-heartbeat"></i>
          <span>Geriatria 360</span>
        </a>
        
        <nav class="medical-nav">
          <a href="index.html"><i class="fas fa-home"></i> Início</a>
          <a href="recepcao.html"><i class="fas fa-user-injured"></i> Recepção</a>
          <a href="triagem.html"><i class="fas fa-stethoscope"></i> Triagem</a>
        </nav>
        
        <div class="medical-user">
          <img src="https://ui-avatars.com/api/?name=Dr+Silva&background=2c5aa0&color=fff" alt="Dr. Silva">
          <div>
            <div>Dr. Silva</div>
            <small>Geriatra</small>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section id="loginArea" class="login-container">
    <div class="login-header">
      <h1>Área Médica</h1>
      <p>Acesso restrito a profissionais de saúde</p>
    </div>
    
    <form id="loginForm">
      <div class="form-group">
        <label for="med-user">CRM</label>
        <input type="text" id="med-user" class="form-control" placeholder="Digite seu CRM">
      </div>
      
      <div class="form-group">
        <label for="med-pass">Senha</label>
        <input type="password" id="med-pass" class="form-control" placeholder="Digite sua senha">
      </div>
      
      <button type="button" class="btn btn-block" onclick="loginMed()">Entrar na Área Médica</button>
    </form>
    
    <div class="alert alert-error" id="loginError" style="display: none;">
      CRM ou senha incorretos. Tente novamente.
    </div>

    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: var(--border-radius);">
      <p><strong>Credenciais de Teste:</strong></p>
      <p>CRM: <strong>123456</strong></p>
      <p>Senha: <strong>medico123</strong></p>
    </div>
  </section>

  <section id="medicalArea" class="medical-main">
    <div class="container">
      <div class="medical-dashboard">
        <aside class="medical-sidebar">
          <div class="patient-info">
            <img src="https://ui-avatars.com/api/?name=Médico&background=2c5aa0&color=fff" alt="Médico" class="patient-avatar">
            <h3 id="medicName">Dr. Silva</h3>
            <p>CRM: <strong>123456</strong></p>
          </div>
          
          <div class="patient-details">
            <div class="detail-item">
              <span class="detail-label">Agendamentos Hoje</span>
              <span class="detail-value" id="agendamentosCount">0</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Em Atendimento</span>
              <span class="detail-value" id="atendimentosCount">0</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Finalizados</span>
              <span class="detail-value" id="finalizadosCount">0</span>
            </div>
          </div>
          
          <div class="medical-tabs">
            <a href="#" class="medical-tab active" data-tab="dashboard">
              <i class="fas fa-home"></i>
              <span>Dashboard</span>
            </a>
            <a href="#" class="medical-tab" data-tab="evolucao">
              <i class="fas fa-stethoscope"></i>
              <span>Evolução Médica</span>
            </a>
            <a href="#" class="medical-tab" data-tab="medicacao">
              <i class="fas fa-pills"></i>
              <span>Medicação</span>
            </a>
            <a href="#" class="medical-tab" data-tab="atestados">
              <i class="fas fa-file-medical"></i>
              <span>Atestados</span>
            </a>
            <a href="#" class="medical-tab" data-tab="documentos">
              <i class="fas fa-file-contract"></i>
              <span>Documentos</span>
            </a>
            <a href="#" class="medical-tab" data-tab="agendamento">
              <i class="fas fa-calendar-check"></i>
              <span>Agendamento</span>
            </a>
            <a href="#" class="medical-tab" data-tab="exames">
              <i class="fas fa-vial"></i>
              <span>Solicitar Exames</span>
            </a>
          </div>
        </aside>
        
        <main class="medical-content">
          <!-- Dashboard -->
          <div id="dashboard" class="tab-content active">
            <div class="tab-header">
              <h2>Dashboard Médico</h2>
              <div class="tab-actions">
                <button class="btn" onclick="carregarAgendamentosDoDia()">
                  <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                <button class="btn btn-success" onclick="criarDadosDemonstracao()">
                  <i class="fas fa-plus"></i> Criar Dados de Teste
                </button>
                <button class="btn" onclick="testarIntegracao()">
                  <i class="fas fa-vial"></i> Testar Integração
                </button>
              </div>
            </div>
            
            <div class="agendamentos-dia-container">
              <div class="agendamentos-header">
                <h3><i class="fas fa-calendar-day"></i> Agendamentos de Hoje</h3>
                <span class="badge badge-primary" id="totalAgendamentosHoje">0 agendamentos</span>
              </div>
              
              <div id="agendamentosDoDia" class="agendamentos-grid">
                <!-- Agendamentos serão carregados aqui -->
              </div>
            </div>
            
            <div class="agendamentos-dia-container">
              <div class="agendamentos-header">
                <h3><i class="fas fa-user-injured"></i> Pacientes em Atendimento</h3>
                <span class="badge badge-warning" id="totalAtendimentos">0 pacientes</span>
              </div>
              
              <div id="pacientesAtendimento" class="agendamentos-grid">
                <!-- Pacientes em atendimento serão carregados aqui -->
              </div>
            </div>
          </div>
          
          <!-- Evolução Médica -->
          <div id="evolucao" class="tab-content">
            <div class="tab-header">
              <h2>Evolução Médica</h2>
              <div class="tab-actions">
                <button class="btn" onclick="saveEvolution()"><i class="fas fa-save"></i> Salvar</button>
                <button class="btn btn-success" onclick="generateAIReport()"><i class="fas fa-robot"></i> Gerar Laudo IA</button>
              </div>
            </div>
            
            <div id="pacienteInfoEvolucao" style="background: #e8f4fd; padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; display: none;">
              <h4 id="nomePacienteEvolucao"></h4>
              <p id="detalhesPacienteEvolucao"></p>
            </div>
            
            <div class="alert alert-error" id="alertNoPatient" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i> Nenhum paciente selecionado. Selecione um paciente na aba "Dashboard" para iniciar o atendimento.
            </div>
            
            <div class="cid-search-container">
              <input type="text" id="cidSearch" class="form-control" placeholder="Digite código CID-10 (ex: I10) ou descrição...">
              <div id="cidResults" class="cid-results"></div>
            </div>
            
            <div id="cidChips" class="cid-chips"></div>
            
            <div class="editor-container">
              <div class="editor-toolbar">
                <button type="button" title="Negrito" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                <button type="button" title="Itálico" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                <button type="button" title="Sublinhado" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                <button type="button" title="Lista" onclick="formatText('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                <button type="button" title="Lista Numerada" onclick="formatText('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
              </div>
              <div id="evolText" class="medical-editor" contenteditable="true">
                <p><strong>Queixa Principal:</strong> </p>
                <p><strong>História da Doença Atual:</strong> </p>
                <p><strong>Exame Físico:</strong> </p>
                <p><strong>Conduta:</strong> </p>
              </div>
            </div>
            
            <!-- Finalizar Atendimento -->
            <div class="finalization-card" id="finalizationCard" style="display: none;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="color: var(--success); margin-bottom: 5px;">
                    <i class="fas fa-check-circle"></i> Finalizar Atendimento
                  </h3>
                  <p style="color: var(--gray); margin: 0;" id="statusPaciente">
                    Pronto para finalizar atendimento
                  </p>
                </div>
                <button class="btn btn-success" onclick="finalizarAtendimento()" style="font-size: 1.1rem;">
                  <i class="fas fa-flag-checkered"></i> Finalizar Atendimento
                </button>
              </div>
            </div>
          </div>
          
          <!-- Medicação -->
          <div id="medicacao" class="tab-content">
            <div class="tab-header">
              <h2>Prescrição de Medicação</h2>
              <div class="tab-actions">
                <button class="btn" onclick="savePrescription()"><i class="fas fa-save"></i> Salvar Receita</button>
                <button class="btn" onclick="printPrescription()"><i class="fas fa-print"></i> Imprimir</button>
              </div>
            </div>
            
            <div id="alertNoPatientMedicacao" class="no-patient-alert" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i> Nenhum paciente selecionado. Selecione um paciente na aba "Dashboard" para prescrever medicamentos.
            </div>
            
            <div id="medicacaoContent">
              <div class="medication-container">
                <div class="medication-form">
                  <input type="text" id="medName" class="form-control" placeholder="Medicamento" list="medSuggestions">
                  <datalist id="medSuggestions">
                    <option value="Losartana 50mg">
                    <option value="AAS 100mg">
                    <option value="Sinvastatina 20mg">
                    <option value="Metformina 850mg">
                    <option value="Omeprazol 20mg">
                    <option value="Clopidogrel 75mg">
                    <option value="Atenolol 50mg">
                    <option value="Hidroclorotiazida 25mg">
                  </datalist>
                  <input type="text" id="medDosage" class="form-control" placeholder="Posologia (ex: 1x ao dia)">
                  <input type="text" id="medDuration" class="form-control" placeholder="Duração (ex: 30 dias)">
                  <button type="button" class="btn" onclick="addMedication()"><i class="fas fa-plus"></i> Adicionar</button>
                </div>
                
                <div class="medication-list" id="medicationListContainer">
                  <!-- Medicamentos aparecerão aqui -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Atestados -->
          <div id="atestados" class="tab-content">
            <div class="tab-header">
              <h2>Emitir Atestados</h2>
              <div class="tab-actions">
                <button class="btn" onclick="saveCertificate()"><i class="fas fa-save"></i> Salvar</button>
                <button class="btn" onclick="printCertificate()"><i class="fas fa-print"></i> Imprimir</button>
              </div>
            </div>
            
            <div id="alertNoPatientAtestado" class="no-patient-alert" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i> Nenhum paciente selecionado. Selecione um paciente na aba "Dashboard" para emitir atestados.
            </div>
            
            <div id="atestadosContent">
              <div class="form-group">
                <label for="certModel">Modelo de Atestado</label>
                <select id="certModel" class="form-control" onchange="changeCertModel(this.value)">
                  <option value="">Selecione um modelo</option>
                  <option value="modelo1">Modelo 1 - Afastamento</option>
                  <option value="modelo2">Modelo 2 - Aptidão Física</option>
                  <option value="modelo3">Modelo 3 - Comparecimento</option>
                  <option value="modelo4">Modelo 4 - Acompanhante</option>
                </select>
              </div>

              <div id="certFields">
                <!-- Campos dinâmicos aparecem aqui -->
              </div>

              <div class="form-group">
                <label for="cidSearchAtestado">CID-10 (opcional)</label>
                <div class="cid-search-container">
                  <input type="text" id="cidSearchAtestado" class="form-control" placeholder="Digite código CID-10 ou descrição...">
                  <div id="cidResultsAtestado" class="cid-results"></div>
                </div>
                <div id="cidChipsAtestado" class="cid-chips"></div>
              </div>

              <div class="form-group">
                <label for="certReason">Texto do Atestado</label>
                <textarea id="certReason" class="form-control" rows="8" placeholder="O texto do atestado será preenchido automaticamente..."></textarea>
              </div>
            </div>
          </div>
          
          <!-- Documentos -->
          <div id="documentos" class="tab-content">
            <div class="tab-header">
              <h2>Documentos Médicos</h2>
              <div class="tab-actions">
                <button class="btn" onclick="newDocument()"><i class="fas fa-plus"></i> Novo Documento</button>
              </div>
            </div>
            
            <div class="documents-grid">
              <div class="document-card">
                <div class="document-icon">
                  <i class="fas fa-file-prescription"></i>
                </div>
                <h3>Receituário</h3>
                <p>Prescrição de medicamentos controlados e simples</p>
                <button class="btn" onclick="openDocument('receita')">Abrir</button>
              </div>
              
              <div class="document-card">
                <div class="document-icon">
                  <i class="fas fa-file-medical-alt"></i>
                </div>
                <h3>Solicitação de Exames</h3>
                <p>Solicitação de exames laboratoriais e de imagem</p>
                <button class="btn" onclick="openDocument('exames')">Abrir</button>
              </div>
              
              <div class="document-card">
                <div class="document-icon">
                  <i class="fas fa-ambulance"></i>
                </div>
                <h3>Encaminhamento</h3>
                <p>Encaminhamento para especialistas ou serviços de saúde</p>
                <button class="btn" onclick="openDocument('encaminhamento')">Abrir</button>
              </div>
              
              <div class="document-card">
                <div class="document-icon">
                  <i class="fas fa-procedures"></i>
                </div>
                <h3>Relatório de Internação</h3>
                <p>Relatório médico para processos de internação</p>
                <button class="btn" onclick="openDocument('internacao')">Abrir</button>
              </div>
            </div>
          </div>
          
          <!-- Agendamento -->
          <div id="agendamento" class="tab-content">
            <div class="tab-header">
              <h2>Agendamento de Consultas</h2>
              <div class="tab-actions">
                <button class="btn" onclick="newAppointment()"><i class="fas fa-plus"></i> Nova Consulta</button>
              </div>
            </div>
            
            <div class="calendar-container">
              <div class="calendar-header">
                <div class="calendar-nav">
                  <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                </div>
                <h3 id="currentMonth">Junho 2023</h3>
                <div class="calendar-nav">
                  <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
              </div>
              
              <div class="calendar-grid">
                <div class="calendar-day">Dom</div>
                <div class="calendar-day">Seg</div>
                <div class="calendar-day">Ter</div>
                <div class="calendar-day">Qua</div>
                <div class="calendar-day">Qui</div>
                <div class="calendar-day">Sex</div>
                <div class="calendar-day">Sáb</div>
              </div>
              
              <div id="calendarDates" class="calendar-dates">
                <!-- Datas serão inseridas aqui pelo JavaScript -->
              </div>
            </div>
            
            <div class="appointment-list">
              <h3 style="margin-bottom: 20px;">Consultas Agendadas</h3>
              
              <div class="appointment-item">
                <div class="appointment-info">
                  <h4>Maria Silva</h4>
                  <p>Consulta de rotina - Geriatria</p>
                </div>
                <div class="appointment-time">
                  10:00 - 10:40
                </div>
                <div class="appointment-status status-confirmed">
                  Confirmada
                </div>
              </div>
              
              <div class="appointment-item">
                <div class="appointment-info">
                  <h4>João Santos</h4>
                  <p>Avaliação de memória</p>
                </div>
                <div class="appointment-time">
                  14:30 - 15:15
                </div>
                <div class="appointment-status status-scheduled">
                  Agendada
                </div>
              </div>
            </div>
          </div>
          
          <!-- Solicitar Exames -->
          <div id="exames" class="tab-content">
            <div class="tab-header">
              <h2>Solicitação de Exames</h2>
              <div class="tab-actions">
                <button class="btn" onclick="saveExams()"><i class="fas fa-save"></i> Salvar</button>
                <button class="btn" onclick="printExams()"><i class="fas fa-print"></i> Imprimir</button>
              </div>
            </div>
            
            <div id="alertNoPatientExames" class="no-patient-alert" style="display: none;">
              <i class="fas fa-exclamation-triangle"></i> Nenhum paciente selecionado. Selecione um paciente na aba "Dashboard" para solicitar exames.
            </div>
            
            <div id="examesContent">
              <div class="form-group">
                <label for="examType">Tipo de Exame</label>
                <select id="examType" class="form-control">
                  <option value="laboratorial">Laboratorial</option>
                  <option value="imagem">Imagem</option>
                  <option value="funcional">Funcional</option>
                  <option value="outros">Outros</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="examInput">Exames Solicitados</label>
                <div style="display: flex; gap: 10px;">
                  <input type="text" id="examInput" class="form-control" placeholder="Ex: Hemograma completo, Glicemia...">
                  <button type="button" class="btn" onclick="addExam()"><i class="fas fa-plus"></i> Adicionar</button>
                </div>
              </div>
              
              <div class="form-group">
                <label>Exames Selecionados</label>
                <ul id="examList" style="background: var(--light); padding: 15px; border-radius: var(--border-radius);">
                  <!-- Exames aparecerão aqui -->
                </ul>
              </div>
              
              <div class="form-group">
                <label for="examInstructions">Instruções Especiais</label>
                <textarea id="examInstructions" class="form-control" rows="3" placeholder="Instruções para preparo ou realização dos exames..."></textarea>
              </div>
            </div>
          </div>

          <!-- Painel de Debug -->
          <div class="debug-panel">
            <h4>🔧 Debug do Sistema</h4>
            <button class="btn" onclick="debugSistema()" style="padding: 5px 10px; font-size: 0.8rem; margin-bottom: 10px;">
              <i class="fas fa-bug"></i> Verificar Dados
            </button>
            <div id="debugOutput"></div>
          </div>
        </main>
      </div>
    </div>
  </section>

  <script>
    // ===== SISTEMA PRINCIPAL =====
    let currentAppointment = null;
    let medications = [];
    let exams = [];
    let appointments = [];
    let selectedCids = [];
    let selectedCidsAtestado = [];
    
    // Base de dados de CID-10
    const cidData = [
      { code: "A00", description: "Cólera" },
      { code: "A01", description: "Febres tifóide e paratifóide" },
      { code: "A02", description: "Outras infecções por Salmonella" },
      { code: "I10", description: "Hipertensão essencial (primária)" },
      { code: "I11", description: "Doença cardíaca hipertensiva" },
      { code: "I20", description: "Angina pectoris" },
      { code: "I21", description: "Infarto agudo do miocárdio" },
      { code: "I25", description: "Doença isquêmica crônica do coração" },
      { code: "E10", description: "Diabetes mellitus insulinodependente" },
      { code: "E11", description: "Diabetes mellitus não-insulinodependente" },
      { code: "E66", description: "Obesidade" },
      { code: "F00", description: "Demência na doença de Alzheimer" },
      { code: "F01", description: "Demência vascular" },
      { code: "F03", description: "Demência não especificada" },
      { code: "F10", description: "Transtornos mentais devido ao uso de álcool" },
      { code: "G20", description: "Doença de Parkinson" },
      { code: "G30", description: "Doença de Alzheimer" },
      { code: "J45", description: "Asma" },
      { code: "J44", description: "Outras doenças pulmonares obstrutivas crônicas" },
      { code: "M15", description: "Poliartrose" },
      { code: "M16", description: "Coxartrose (artrose do quadril)" },
      { code: "M17", description: "Gonartrose (artrose do joelho)" },
      { code: "M19", description: "Outras artroses" },
      { code: "N18", description: "Doença renal crônica" },
      { code: "N39", description: "Outros transtornos do sistema urinário" },
      { code: "R05", description: "Tosse" },
      { code: "R06", description: "Anormalidades da respiração" },
      { code: "R53", description: "Mal-estar e fadiga" },
      { code: "Z00", description: "Exame geral de rotina" }
    ];

    // Modelos de atestados
    const certModels = {
      modelo1: `Atesto que {{nome}}, portador(a) do CPF {{cpf}}, esteve sob meus cuidados médicos e necessita de afastamento de suas atividades laborais por {{dias}} dias, a partir da data presente.{{cid}}`,
      
      modelo2: `Atesto que {{nome}}, portador(a) do CPF {{cpf}}, encontra-se apto(a) para a prática de atividades físicas, não apresentando contraindicações médicas no momento deste exame.{{cid}}`,
      
      modelo3: `Atesto para os devidos fins que {{nome}}, portador(a) do CPF {{cpf}}, esteve presente em consulta médica em nosso serviço no dia {{data}}, no período das {{horaInicio}} às {{horaFim}}.{{cid}}`,
      
      modelo4: `Atesto que {{nome}}, portador(a) do CPF {{cpf}}, necessita de acompanhante {{acompanhante}} para consultas e exames médicos devido à sua condição de saúde.{{cid}}`
    };
    
    // Login
    function loginMed() {
      const user = document.getElementById('med-user').value;
      const pass = document.getElementById('med-pass').value;
      
      if (user === '123456' && pass === 'medico123') {
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('medicalArea').style.display = 'block';
        initCIDSearch();
        initCalendar();
        setupTabNavigation();
        
        // Carregar dashboard com agendamentos do dia
        carregarAgendamentosDoDia();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    // Navegação por abas
    function setupTabNavigation() {
      const tabs = document.querySelectorAll('.medical-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remover classe active de todas as abas
          tabs.forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Adicionar classe active à aba clicada
          this.classList.add('active');
          
          // Mostrar conteúdo correspondente
          const tabId = this.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
          
          // Verificar se há paciente selecionado nas abas que precisam
          if (tabId === 'evolucao') {
            verificarPacienteSelecionadoEvolucao();
          } else if (tabId === 'medicacao') {
            verificarPacienteSelecionadoMedicacao();
          } else if (tabId === 'atestados') {
            verificarPacienteSelecionadoAtestados();
          } else if (tabId === 'exames') {
            verificarPacienteSelecionadoExames();
          } else if (tabId === 'dashboard') {
            carregarAgendamentosDoDia(); // Recarregar ao voltar para o dashboard
          }
        });
      });
    }
    
    // Carregar agendamentos do dia - FUNÇÃO CORRIGIDA
    function carregarAgendamentosDoDia() {
      const hoje = new Date().toISOString().split('T')[0];
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      
      console.log('🔍 Buscando agendamentos para hoje:', hoje);
      console.log('📋 Todos os agendamentos:', agendamentos);
      
      // Filtrar agendamentos de hoje
      const agendamentosHoje = agendamentos.filter(ag => {
        console.log(`Agendamento ${ag.id}: data=${ag.data}, status=${ag.status}`);
        return ag.data === hoje && ag.status !== 'finalizado';
      });
      
      console.log('✅ Agendamentos de hoje:', agendamentosHoje);
      
      // Atualizar contadores
      document.getElementById('agendamentosCount').textContent = agendamentosHoje.length;
      document.getElementById('totalAgendamentosHoje').textContent = `${agendamentosHoje.length} agendamentos`;
      
      const emAtendimento = agendamentosHoje.filter(ag => ag.status === 'em_atendimento').length;
      document.getElementById('atendimentosCount').textContent = emAtendimento;
      document.getElementById('totalAtendimentos').textContent = `${emAtendimento} pacientes`;
      
      // Renderizar agendamentos
      const container = document.getElementById('agendamentosDoDia');
      
      if (agendamentosHoje.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <h3>Nenhum agendamento para hoje</h3>
            <p>Não há consultas agendadas para o dia de hoje.</p>
            <p><strong>Clique em "Criar Dados de Teste" para gerar pacientes de exemplo.</strong></p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      agendamentosHoje.forEach(agendamento => {
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        
        // CORREÇÃO MELHORADA: Buscar triagem de forma mais robusta
        const triagem = triagens.find(t => {
          // Tentar por agendamentoId primeiro
          if (t.agendamentoId === agendamento.id) return true;
          // Tentar por pacienteId
          if (t.pacienteId == agendamento.pacienteId) return true;
          // Tentar por nome do paciente
          if (t.pacienteNome && agendamento.pacienteNome && 
              t.pacienteNome === agendamento.pacienteNome) return true;
          return false;
        });
        
        console.log(`Paciente: ${agendamento.pacienteNome}, Triagem encontrada:`, triagem);
        
        const card = document.createElement('div');
        card.className = `agendamento-card ${triagem ? `prioridade-${triagem.prioridade}` : ''}`;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <h4>${agendamento.pacienteNome || paciente.nome || 'Paciente'}</h4>
            <span class="badge ${getStatusBadgeClass(agendamento.status)}">${getStatusText(agendamento.status)}</span>
          </div>
          <p><i class="fas fa-clock"></i> ${agendamento.hora}</p>
          <p><i class="fas fa-user-md"></i> ${agendamento.medico || 'Dr. Silva'}</p>
          ${triagem ? `<p><i class="fas fa-thermometer-half"></i> Prioridade: <strong>${triagem.prioridade}</strong></p>` : ''}
          ${triagem ? `<p><i class="fas fa-heartbeat"></i> PA: ${triagem.pressaoSistolica}/${triagem.pressaoDiastolica} | FC: ${triagem.batimentosCardiacos}</p>` : ''}
          <div class="agendamento-actions">
            ${agendamento.status === 'agendado' ? `<button class="btn" onclick="iniciarAtendimento('${agendamento.id}')"><i class="fas fa-play"></i> Iniciar</button>` : ''}
            ${agendamento.status === 'em_atendimento' ? `<button class="btn btn-success" onclick="continuarAtendimento('${agendamento.id}')"><i class="fas fa-stethoscope"></i> Continuar</button>` : ''}
            <button class="btn" onclick="verDetalhesAgendamento('${agendamento.id}')"><i class="fas fa-info-circle"></i> Detalhes</button>
          </div>
        `;
        
        container.appendChild(card);
      });
      
      // Carregar pacientes em atendimento
      carregarPacientesEmAtendimento();
    }
    
    // Criar dados de demonstração
    function criarDadosDemonstracao() {
      const hoje = new Date().toISOString().split('T')[0];
      
      // Criar paciente de demonstração
      const pacienteDemo = {
        id: 'demo-001',
        nome: 'Maria Silva',
        cpf: '123.456.789-00',
        dataNascimento: '1948-05-15',
        telefone: '(11) 99999-9999',
        endereco: 'Rua das Flores, 123 - São Paulo/SP',
        escolaridade: '8 anos',
        alergias: 'Penicilina',
        comorbidades: 'Hipertensão, Diabetes'
      };
      
      // Criar agendamento de demonstração
      const agendamentoDemo = {
        id: 'agd-' + Date.now(),
        pacienteId: 'demo-001',
        pacienteNome: 'Maria Silva',
        pacienteCPF: '123.456.789-00',
        medico: 'Dr. Silva',
        data: hoje,
        hora: '10:00',
        status: 'agendado',
        tipo: 'Consulta de rotina'
      };
      
      // Criar triagem de demonstração
      const triagemDemo = {
        id: 'trg-' + Date.now(),
        agendamentoId: agendamentoDemo.id,
        pacienteId: 'demo-001',
        pacienteNome: 'Maria Silva',
        queixaPrincipal: 'Dor articular difusa há 3 meses',
        pressaoSistolica: '140',
        pressaoDiastolica: '90',
        batimentosCardiacos: '72',
        temperatura: '36.5',
        saturacaoOxigenio: '98',
        peso: '65',
        altura: '1.60',
        imc: '25.4',
        glicemia: '110',
        prioridade: 'media',
        observacoes: 'Paciente relata piora progressiva da dor'
      };
      
      // Salvar no localStorage
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      if (!pacientes.find(p => p.id === 'demo-001')) {
        pacientes.push(pacienteDemo);
      }
      localStorage.setItem('geriatria_pacientes', JSON.stringify(pacientes));
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      agendamentos.push(agendamentoDemo);
      localStorage.setItem('geriatria_agendamentos', JSON.stringify(agendamentos));
      
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      triagens.push(triagemDemo);
      localStorage.setItem('geriatria_triagens', JSON.stringify(triagens));
      
      showAlert('Dados de demonstração criados com sucesso! Agora você pode iniciar o atendimento.', 'success');
      
      // Recarregar agendamentos
      carregarAgendamentosDoDia();
    }
    
    // Carregar pacientes em atendimento
    function carregarPacientesEmAtendimento() {
      const hoje = new Date().toISOString().split('T')[0];
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      
      const emAtendimento = agendamentos.filter(ag => ag.data === hoje && ag.status === 'em_atendimento');
      
      const container = document.getElementById('pacientesAtendimento');
      
      if (emAtendimento.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-user-clock"></i>
            <h3>Nenhum paciente em atendimento</h3>
            <p>Inicie um atendimento para ver os pacientes aqui.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      emAtendimento.forEach(agendamento => {
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        
        const card = document.createElement('div');
        card.className = 'agendamento-card prioridade-alta';
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
            <h4>${agendamento.pacienteNome || paciente.nome || 'Paciente'}</h4>
            <span class="badge badge-warning">Em Atendimento</span>
          </div>
          <p><i class="fas fa-clock"></i> ${agendamento.hora}</p>
          <p><i class="fas fa-user-md"></i> ${agendamento.medico || 'Dr. Silva'}</p>
          <div class="agendamento-actions">
            <button class="btn btn-success" onclick="continuarAtendimento('${agendamento.id}')"><i class="fas fa-stethoscope"></i> Continuar</button>
            <button class="btn" onclick="verDetalhesAgendamento('${agendamento.id}')"><i class="fas fa-info-circle"></i> Detalhes</button>
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Iniciar atendimento - FUNÇÃO CORRIGIDA
    function iniciarAtendimento(agendamentoId) {
      console.log('🎯 Iniciando atendimento para:', agendamentoId);
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      
      const agendamentoIndex = agendamentos.findIndex(ag => ag.id === agendamentoId);
      
      if (agendamentoIndex !== -1) {
        // Atualizar status do agendamento
        agendamentos[agendamentoIndex].status = 'em_atendimento';
        localStorage.setItem('geriatria_agendamentos', JSON.stringify(agendamentos));
        
        // Carregar dados do paciente
        const agendamento = agendamentos[agendamentoIndex];
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        
        // CORREÇÃO: Buscar triagem de forma mais flexível
        const triagem = triagens.find(t => {
          // Tentar por agendamentoId primeiro
          if (t.agendamentoId === agendamento.id) return true;
          // Tentar por pacienteId
          if (t.pacienteId == agendamento.pacienteId) return true;
          // Tentar por nome do paciente
          if (t.pacienteNome && agendamento.pacienteNome && 
              t.pacienteNome === agendamento.pacienteNome) return true;
          return false;
        });
        
        currentAppointment = {
          id: agendamento.id,
          pacienteId: agendamento.pacienteId,
          pacienteNome: agendamento.pacienteNome || paciente.nome,
          pacienteCPF: agendamento.pacienteCPF || paciente.cpf,
          medico: agendamento.medico,
          data: agendamento.data,
          hora: agendamento.hora,
          status: 'em_atendimento',
          paciente: paciente,
          triagem: triagem
        };
        
        console.log('✅ Current Appointment definido:', currentAppointment);
        
        // Mostrar sucesso
        showAlert(`Atendimento iniciado para <strong>${currentAppointment.pacienteNome}</strong>`, 'success');
        
        // Atualizar dashboard
        carregarAgendamentosDoDia();
        
        // Mudar para aba de evolução
        document.querySelector('.medical-tab[data-tab="evolucao"]').click();
        
        // Atualizar interface do paciente
        atualizarInterfacePaciente();
      } else {
        console.error('❌ Agendamento não encontrado com ID:', agendamentoId);
        showAlert('Erro: Agendamento não encontrado.', 'error');
      }
    }
    
    // Continuar atendimento
    function continuarAtendimento(agendamentoId) {
      console.log('🎯 Continuando atendimento para:', agendamentoId);
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      
      const agendamento = agendamentos.find(ag => ag.id === agendamentoId);
      
      if (agendamento) {
        const paciente = pacientes.find(p => p.id == agendamento.pacienteId) || {};
        
        // CORREÇÃO: Buscar triagem de forma mais flexível
        const triagem = triagens.find(t => {
          // Tentar por agendamentoId primeiro
          if (t.agendamentoId === agendamento.id) return true;
          // Tentar por pacienteId
          if (t.pacienteId == agendamento.pacienteId) return true;
          // Tentar por nome do paciente
          if (t.pacienteNome && agendamento.pacienteNome && 
              t.pacienteNome === agendamento.pacienteNome) return true;
          return false;
        });
        
        currentAppointment = {
          id: agendamento.id,
          pacienteId: agendamento.pacienteId,
          pacienteNome: agendamento.pacienteNome || paciente.nome,
          pacienteCPF: agendamento.pacienteCPF || paciente.cpf,
          medico: agendamento.medico,
          data: agendamento.data,
          hora: agendamento.hora,
          status: agendamento.status,
          paciente: paciente,
          triagem: triagem
        };
        
        console.log('✅ Current Appointment atualizado:', currentAppointment);
        
        // Mudar para aba de evolução
        document.querySelector('.medical-tab[data-tab="evolucao"]').click();
        
        // Atualizar interface do paciente
        atualizarInterfacePaciente();
      } else {
        console.error('❌ Agendamento não encontrado com ID:', agendamentoId);
        showAlert('Erro: Agendamento não encontrado.', 'error');
      }
    }
    
    // Atualizar interface do paciente
    function atualizarInterfacePaciente() {
      if (currentAppointment) {
        // Mostrar informações do paciente
        document.getElementById('pacienteInfoEvolucao').style.display = 'block';
        document.getElementById('nomePacienteEvolucao').textContent = currentAppointment.pacienteNome;
        
        let detalhes = `ID: ${currentAppointment.pacienteId} | CPF: ${formatCPF(currentAppointment.pacienteCPF)}`;
        if (currentAppointment.triagem) {
          detalhes += ` | Prioridade: ${currentAppointment.triagem.prioridade} | PA: ${currentAppointment.triagem.pressaoSistolica}/${currentAppointment.triagem.pressaoDiastolica}`;
        }
        
        document.getElementById('detalhesPacienteEvolucao').textContent = detalhes;
        
        // Mostrar card de finalização
        document.getElementById('finalizationCard').style.display = 'block';
        
        // Esconder alerta de nenhum paciente
        document.getElementById('alertNoPatient').style.display = 'none';
        
        // Carregar dados da triagem no editor, se existirem
        if (currentAppointment.triagem) {
          carregarDadosTriagem();
        }
      }
    }
    
    // Carregar dados da triagem no editor
    function carregarDadosTriagem() {
      if (!currentAppointment || !currentAppointment.triagem) return;
      
      const triagem = currentAppointment.triagem;
      let triagemHTML = `
        <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
          <p style="margin: 0 0 10px 0;"><strong>📋 DADOS DA TRIAGEM:</strong></p>
          <p style="margin: 5px 0;"><strong>Queixa Principal:</strong> ${triagem.queixaPrincipal}</p>
          <p style="margin: 5px 0;"><strong>Sinais Vitais:</strong> PA ${triagem.pressaoSistolica}/${triagem.pressaoDiastolica} | FC ${triagem.batimentosCardiacos} bpm | Temp ${triagem.temperatura}°C | Sat O₂ ${triagem.saturacaoOxigenio}%</p>
          <p style="margin: 5px 0;"><strong>Antropometria:</strong> Peso ${triagem.peso}kg | Altura ${triagem.altura}m | IMC ${triagem.imc}</p>
          ${triagem.glicemia ? `<p style="margin: 5px 0;"><strong>Glicemia:</strong> ${triagem.glicemia} mg/dL</p>` : ''}
          ${triagem.observacoes ? `<p style="margin: 5px 0;"><strong>Observações da Triagem:</strong> ${triagem.observacoes}</p>` : ''}
          <p style="margin: 5px 0;"><strong>Prioridade:</strong> <span style="color: ${getPriorityColor(triagem.prioridade)}; font-weight: bold;">${triagem.prioridade.toUpperCase()}</span></p>
        </div>
        <hr>
      `;
      
      const evolText = document.getElementById('evolText');
      evolText.innerHTML = triagemHTML + evolText.innerHTML;
    }
    
    // Verificar se há paciente selecionado nas diferentes abas
    function verificarPacienteSelecionadoEvolucao() {
      if (!currentAppointment) {
        document.getElementById('alertNoPatient').style.display = 'block';
        document.getElementById('finalizationCard').style.display = 'none';
        document.getElementById('pacienteInfoEvolucao').style.display = 'none';
      } else {
        document.getElementById('alertNoPatient').style.display = 'none';
        document.getElementById('finalizationCard').style.display = 'block';
        document.getElementById('pacienteInfoEvolucao').style.display = 'block';
      }
    }
    
    function verificarPacienteSelecionadoMedicacao() {
      if (!currentAppointment) {
        document.getElementById('alertNoPatientMedicacao').style.display = 'block';
        document.getElementById('medicacaoContent').style.display = 'none';
      } else {
        document.getElementById('alertNoPatientMedicacao').style.display = 'none';
        document.getElementById('medicacaoContent').style.display = 'block';
      }
    }
    
    function verificarPacienteSelecionadoAtestados() {
      if (!currentAppointment) {
        document.getElementById('alertNoPatientAtestado').style.display = 'block';
        document.getElementById('atestadosContent').style.display = 'none';
      } else {
        document.getElementById('alertNoPatientAtestado').style.display = 'none';
        document.getElementById('atestadosContent').style.display = 'block';
      }
    }
    
    function verificarPacienteSelecionadoExames() {
      if (!currentAppointment) {
        document.getElementById('alertNoPatientExames').style.display = 'block';
        document.getElementById('examesContent').style.display = 'none';
      } else {
        document.getElementById('alertNoPatientExames').style.display = 'none';
        document.getElementById('examesContent').style.display = 'block';
      }
    }
    
    // Finalizar atendimento
    function finalizarAtendimento() {
      if (!currentAppointment) {
        showAlert('Nenhum paciente em atendimento para finalizar.', 'error');
        return;
      }
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const agendamentoIndex = agendamentos.findIndex(ag => ag.id === currentAppointment.id);
      
      if (agendamentoIndex !== -1) {
        // Atualizar status do agendamento
        agendamentos[agendamentoIndex].status = 'finalizado';
        agendamentos[agendamentoIndex].dataFinalizacao = new Date().toISOString();
        localStorage.setItem('geriatria_agendamentos', JSON.stringify(agendamentos));
        
        // Salvar prontuário
        salvarProntuarioCompleto();
        
        showAlert(`Atendimento de <strong>${currentAppointment.pacienteNome}</strong> finalizado com sucesso!`, 'success');
        
        // Limpar dados do atendimento atual
        currentAppointment = null;
        
        // Atualizar dashboard
        carregarAgendamentosDoDia();
        
        // Voltar para o dashboard
        document.querySelector('.medical-tab[data-tab="dashboard"]').click();
        
        // Limpar editor
        document.getElementById('evolText').innerHTML = `
          <p><strong>Queixa Principal:</strong> </p>
          <p><strong>História da Doença Atual:</strong> </p>
          <p><strong>Exame Físico:</strong> </p>
          <p><strong>Conduta:</strong> </p>
        `;
      }
    }
    
    // Salvar prontuário completo
    function salvarProntuarioCompleto() {
      if (!currentAppointment) return;
      
      const prontuario = {
        id: Date.now(),
        agendamentoId: currentAppointment.id,
        pacienteId: currentAppointment.pacienteId,
        pacienteNome: currentAppointment.pacienteNome,
        pacienteCPF: currentAppointment.pacienteCPF,
        medico: currentAppointment.medico,
        dataAtendimento: new Date().toISOString(),
        evolucao: document.getElementById('evolText').innerHTML,
        medicamentos: medications,
        exames: exams,
        diagnosticos: selectedCids,
        observacoes: "Atendimento finalizado pelo sistema"
      };
      
      // Salvar no localStorage
      const prontuarios = JSON.parse(localStorage.getItem('geriatria_prontuarios')) || [];
      prontuarios.push(prontuario);
      localStorage.setItem('geriatria_prontuarios', JSON.stringify(prontuarios));
    }
    
    // Funções auxiliares
    function getStatusBadgeClass(status) {
      switch(status) {
        case 'agendado': return 'badge-primary';
        case 'em_atendimento': return 'badge-warning';
        case 'finalizado': return 'badge-success';
        default: return 'badge-primary';
      }
    }
    
    function getStatusText(status) {
      switch(status) {
        case 'agendado': return 'Agendado';
        case 'em_atendimento': return 'Em Atendimento';
        case 'finalizado': return 'Finalizado';
        default: return status;
      }
    }
    
    function getPriorityColor(prioridade) {
      switch(prioridade) {
        case 'alta': return '#e74c3c';
        case 'media': return '#f39c12';
        case 'baixa': return '#27ae60';
        default: return '#6c757d';
      }
    }
    
    function formatCPF(cpf) {
      if (!cpf) return 'Não informado';
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length !== 11) return cpf;
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }
    
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = message;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '100px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.minWidth = '300px';
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
    
    // Funções para ver detalhes do agendamento (placeholder)
    function verDetalhesAgendamento(agendamentoId) {
      showAlert('Funcionalidade de detalhes em desenvolvimento', 'success');
    }

    // ===== FUNÇÕES EXISTENTES DAS OUTRAS ABAS =====

    // Busca de CID para evolução
    function initCIDSearch() {
      const cidSearch = document.getElementById('cidSearch');
      const cidResults = document.getElementById('cidResults');
      
      cidSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        
        if (query.length < 2) {
          cidResults.style.display = 'none';
          return;
        }
        
        const filtered = cidData.filter(item => 
          item.code.toLowerCase().includes(query) || 
          item.description.toLowerCase().includes(query)
        );
        
        displayCIDResults(filtered);
      });
      
      // Fechar resultados ao clicar fora
      document.addEventListener('click', function(e) {
        if (!cidSearch.contains(e.target) && !cidResults.contains(e.target)) {
          cidResults.style.display = 'none';
        }
      });
    }
    
    function displayCIDResults(results) {
      const cidResults = document.getElementById('cidResults');
      cidResults.innerHTML = '';
      
      if (results.length === 0) {
        cidResults.innerHTML = '<div class="cid-result">Nenhum resultado encontrado</div>';
      } else {
        results.forEach(item => {
          const div = document.createElement('div');
          div.className = 'cid-result';
          div.innerHTML = `<strong>${item.code}</strong> - ${item.description}`;
          div.addEventListener('click', () => selectCID(item));
          cidResults.appendChild(div);
        });
      }
      
      cidResults.style.display = 'block';
    }
    
    function selectCID(cid) {
      if (!selectedCids.find(item => item.code === cid.code)) {
        selectedCids.push(cid);
        updateCIDChips();
      }
      
      document.getElementById('cidSearch').value = '';
      document.getElementById('cidResults').style.display = 'none';
    }
    
    function updateCIDChips() {
      const container = document.getElementById('cidChips');
      container.innerHTML = '';
      
      selectedCids.forEach(cid => {
        const chip = document.createElement('div');
        chip.className = 'cid-chip';
        chip.innerHTML = `
          ${cid.code} - ${cid.description}
          <button onclick="removeCID('${cid.code}')"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(chip);
      });
    }
    
    function removeCID(code) {
      selectedCids = selectedCids.filter(item => item.code !== code);
      updateCIDChips();
    }
    
    // Formatação de texto no editor
    function formatText(command) {
      document.execCommand(command, false, null);
      document.getElementById('evolText').focus();
    }
    
    // Sistema de medicamentos
    function addMedication() {
      const name = document.getElementById('medName').value;
      const dosage = document.getElementById('medDosage').value;
      const duration = document.getElementById('medDuration').value;
      
      if (name && dosage) {
        medications.push({ name, dosage, duration });
        renderMedications();
        document.getElementById('medName').value = '';
        document.getElementById('medDosage').value = '';
        document.getElementById('medDuration').value = '';
      } else {
        alert('Preencha pelo menos o nome e a posologia do medicamento.');
      }
    }
    
    function renderMedications() {
      const container = document.getElementById('medicationListContainer');
      container.innerHTML = '';
      
      medications.forEach((med, index) => {
        const medItem = document.createElement('div');
        medItem.className = 'medication-item';
        medItem.innerHTML = `
          <div><strong>${med.name}</strong></div>
          <div>${med.dosage}</div>
          <div>${med.duration}</div>
          <div class="medication-actions">
            <button onclick="removeMedication(${index})"><i class="fas fa-trash"></i></button>
          </div>
        `;
        container.appendChild(medItem);
      });
    }
    
    function removeMedication(index) {
      medications.splice(index, 1);
      renderMedications();
    }
    
    function savePrescription() {
      if (medications.length === 0) {
        alert('Adicione pelo menos um medicamento antes de salvar.');
        return;
      }
      
      const patientName = currentAppointment ? currentAppointment.pacienteNome : 'Paciente';
      const patientCPF = currentAppointment ? currentAppointment.pacienteCPF : 'Não informado';
      
      const prescription = {
        patient: patientName,
        patientCPF: patientCPF,
        medications: medications,
        date: new Date().toISOString(),
        doctor: "Dr. Silva"
      };
      
      localStorage.setItem('lastPrescription', JSON.stringify(prescription));
      showAlert('Receita salva com sucesso!', 'success');
    }
    
    function printPrescription() {
      if (medications.length === 0) {
        alert('Adicione pelo menos um medicamento antes de imprimir.');
        return;
      }
      
      const patientName = currentAppointment ? currentAppointment.pacienteNome : 'Paciente';
      const patientCPF = currentAppointment ? formatCPF(currentAppointment.pacienteCPF) : 'Não informado';

      const printContent = `
        <div style="padding: 20px; font-family: Arial;">
          <h2>Receita Médica - Geriatria 360</h2>
          <p><strong>Paciente:</strong> ${patientName}</p>
          <p><strong>CPF:</strong> ${patientCPF}</p>
          <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
          <hr>
          <h3>Medicações Prescritas:</h3>
          <ul>
            ${medications.map(med => 
              `<li><strong>${med.name}</strong> - ${med.dosage} - ${med.duration}</li>`
            ).join('')}
          </ul>
          <br><br>
          <p>________________________________</p>
          <p><strong>Dr. Silva</strong><br>CRM: 123456</p>
        </div>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }
    
    // Sistema de exames
    function addExam() {
      const examInput = document.getElementById('examInput');
      const examValue = examInput.value.trim();
      
      if (examValue) {
        exams.push(examValue);
        renderExams();
        examInput.value = '';
      } else {
        alert('Digite um exame para adicionar.');
      }
    }
    
    function renderExams() {
      const examList = document.getElementById('examList');
      examList.innerHTML = '';
      
      exams.forEach((exam, index) => {
        const li = document.createElement('li');
        li.style.cssText = 'display: flex; justify-content: between; padding: 8px 0; border-bottom: 1px solid var(--gray-light);';
        li.innerHTML = `
          <span>${exam}</span>
          <button style="background: none; border: none; color: var(--danger); cursor: pointer;" onclick="removeExam(${index})">
            <i class="fas fa-times"></i>
          </button>
        `;
        examList.appendChild(li);
      });
    }
    
    function removeExam(index) {
      exams.splice(index, 1);
      renderExams();
    }
    
    function saveExams() {
      if (exams.length === 0) {
        alert('Adicione pelo menos um exame antes de salvar.');
        return;
      }
      
      const patientName = currentAppointment ? currentAppointment.pacienteNome : 'Paciente';
      const patientCPF = currentAppointment ? currentAppointment.pacienteCPF : 'Não informado';

      const examData = {
        patient: patientName,
        patientCPF: patientCPF,
        exams: exams,
        date: new Date().toISOString(),
        instructions: document.getElementById('examInstructions').value
      };
      
      localStorage.setItem('lastExams', JSON.stringify(examData));
      showAlert('Solicitação de exames salva com sucesso!', 'success');
    }
    
    function printExams() {
      if (exams.length === 0) {
        alert('Adicione pelo menos um exame antes de imprimir.');
        return;
      }
      
      const patientName = currentAppointment ? currentAppointment.pacienteNome : 'Paciente';
      const patientCPF = currentAppointment ? formatCPF(currentAppointment.pacienteCPF) : 'Não informado';
      const instructions = document.getElementById('examInstructions').value;
      
      const printContent = `
        <div style="padding: 20px; font-family: Arial;">
          <h2>Solicitação de Exames - Geriatria 360</h2>
          <p><strong>Paciente:</strong> ${patientName}</p>
          <p><strong>CPF:</strong> ${patientCPF}</p>
          <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
          <hr>
          <h3>Exames Solicitados:</h3>
          <ul>
            ${exams.map(exam => `<li>${exam}</li>`).join('')}
          </ul>
          ${instructions ? `<h3>Instruções:</h3><p>${instructions}</p>` : ''}
          <br><br>
          <p>________________________________</p>
          <p><strong>Dr. Silva</strong><br>CRM: 123456</p>
        </div>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }
    
    // Sistema de atestados
    function changeCertModel(model) {
      const certReason = document.getElementById('certReason');
      const certFields = document.getElementById('certFields');
      
      // Limpar campos anteriores
      certFields.innerHTML = '';
      selectedCidsAtestado = [];
      updateCIDChipsAtestado();
      
      if (model && certModels[model]) {
        const patientName = currentAppointment ? currentAppointment.pacienteNome : 'Paciente';
        const patientCPF = currentAppointment ? formatCPF(currentAppointment.pacienteCPF) : 'Não informado';

        // Preencher texto base do modelo com dados automáticos
        let text = certModels[model];
        text = text.replace(/{{nome}}/g, patientName);
        text = text.replace(/{{cpf}}/g, patientCPF);
        certReason.value = text;
        
        // Adicionar campos específicos do modelo
        switch(model) {
          case 'modelo1':
            certFields.innerHTML = `
              <div class="cert-field-group">
                <div class="form-group">
                  <label>Nome do Paciente</label>
                  <input type="text" class="form-control" value="${patientName}" readonly style="background-color: #f8f9fa;">
                </div>
                <div class="form-group">
                  <label>CPF</label>
                  <input type="text" class="form-control" value="${patientCPF}" readonly style="background-color: #f8f9fa;">
                </div>
              </div>
              <div class="form-group">
                <label for="certDias">Dias de Afastamento</label>
                <input type="number" id="certDias" class="form-control" min="1" value="3" onchange="updateCertText()">
              </div>
            `;
            break;
            
          case 'modelo2':
            certFields.innerHTML = `
              <div class="form-group">
                <label>Nome do Paciente</label>
                <input type="text" class="form-control" value="${patientName}" readonly style="background-color: #f8f9fa;">
              </div>
              <div class="form-group">
                <label>CPF</label>
                <input type="text" class="form-control" value="${patientCPF}" readonly style="background-color: #f8f9fa;">
              </div>
            `;
            break;
            
          case 'modelo3':
            const today = new Date().toISOString().split('T')[0];
            certFields.innerHTML = `
              <div class="cert-field-group">
                <div class="form-group">
                  <label>Nome do Paciente</label>
                  <input type="text" class="form-control" value="${patientName}" readonly style="background-color: #f8f9fa;">
                </div>
                <div class="form-group">
                  <label>CPF</label>
                  <input type="text" class="form-control" value="${patientCPF}" readonly style="background-color: #f8f9fa;">
                </div>
              </div>
              <div class="cert-field-group">
                <div class="form-group">
                  <label for="certData">Data do Atendimento</label>
                  <input type="date" id="certData" class="form-control" value="${today}" onchange="updateCertText()">
                </div>
                <div class="form-group">
                  <label for="certHoraInicio">Hora Início</label>
                  <input type="time" id="certHoraInicio" class="form-control" value="09:00" onchange="updateCertText()">
                </div>
                <div class="form-group">
                  <label for="certHoraFim">Hora Fim</label>
                  <input type="time" id="certHoraFim" class="form-control" value="10:00" onchange="updateCertText()">
                </div>
              </div>
            `;
            break;
            
          case 'modelo4':
            certFields.innerHTML = `
              <div class="cert-field-group">
                <div class="form-group">
                  <label>Nome do Paciente</label>
                  <input type="text" class="form-control" value="${patientName}" readonly style="background-color: #f8f9fa;">
                </div>
                <div class="form-group">
                  <label>CPF</label>
                  <input type="text" class="form-control" value="${patientCPF}" readonly style="background-color: #f8f9fa;">
                </div>
              </div>
              <div class="form-group">
                <label for="certAcompanhante">Nome do Acompanhante</label>
                <input type="text" id="certAcompanhante" class="form-control" placeholder="Nome do acompanhante" onchange="updateCertText()">
              </div>
            `;
            break;
        }
        
        // Inicializar busca de CID para este modelo
        initCIDSearchAtestado();
      }
    }

    function updateCertText() {
      const model = document.getElementById('certModel').value;
      if (!model) return;

      const patientName = currentAppointment ? currentAppointment.pacienteNome : 'Paciente';
      const patientCPF = currentAppointment ? formatCPF(currentAppointment.pacienteCPF) : 'Não informado';

      let text = certModels[model];
      text = text.replace(/{{nome}}/g, patientName);
      text = text.replace(/{{cpf}}/g, patientCPF);

      switch(model) {
        case 'modelo1':
          const dias = document.getElementById('certDias') ? document.getElementById('certDias').value : '3';
          text = text.replace(/{{dias}}/g, dias);
          break;
        case 'modelo3':
          const data = document.getElementById('certData') ? document.getElementById('certData').value : new Date().toISOString().split('T')[0];
          const horaInicio = document.getElementById('certHoraInicio') ? document.getElementById('certHoraInicio').value : '09:00';
          const horaFim = document.getElementById('certHoraFim') ? document.getElementById('certHoraFim').value : '10:00';
          const dataFormatada = data ? new Date(data).toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR');
          text = text.replace(/{{data}}/g, dataFormatada);
          text = text.replace(/{{horaInicio}}/g, horaInicio);
          text = text.replace(/{{horaFim}}/g, horaFim);
          break;
        case 'modelo4':
          const acompanhante = document.getElementById('certAcompanhante') ? document.getElementById('certAcompanhante').value : '';
          text = text.replace(/{{acompanhante}}/g, acompanhante);
          break;
      }

      // Adicionar CIDs se houver
      if (selectedCidsAtestado.length > 0) {
        const cids = selectedCidsAtestado.map(cid => `${cid.code} - ${cid.description}`).join(', ');
        text = text.replace(/{{cid}}/g, `\nCID: ${cids}`);
      } else {
        text = text.replace(/{{cid}}/g, '');
      }

      document.getElementById('certReason').value = text;
    }
    
    // Sistema de CID-10 para atestado
    function initCIDSearchAtestado() {
      const cidSearch = document.getElementById('cidSearchAtestado');
      const cidResults = document.getElementById('cidResultsAtestado');
      
      if (!cidSearch) return;
      
      cidSearch.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        
        if (query.length < 2) {
          cidResults.style.display = 'none';
          return;
        }
        
        const filtered = cidData.filter(item => 
          item.code.toLowerCase().includes(query) || 
          item.description.toLowerCase().includes(query)
        );
        
        displayCIDResultsAtestado(filtered);
      });
      
      document.addEventListener('click', function(e) {
        if (!cidSearch.contains(e.target) && !cidResults.contains(e.target)) {
          cidResults.style.display = 'none';
        }
      });
    }
    
    function displayCIDResultsAtestado(results) {
      const cidResults = document.getElementById('cidResultsAtestado');
      cidResults.innerHTML = '';
      
      if (results.length === 0) {
        cidResults.innerHTML = '<div class="cid-result">Nenhum CID encontrado</div>';
      } else {
        results.slice(0, 10).forEach(item => {
          const div = document.createElement('div');
          div.className = 'cid-result';
          div.innerHTML = `<strong>${item.code}</strong> - ${item.description}`;
          div.addEventListener('click', () => selectCIDAtestado(item));
          cidResults.appendChild(div);
        });
      }
      
      cidResults.style.display = 'block';
    }
    
    function selectCIDAtestado(cid) {
      if (!selectedCidsAtestado.find(item => item.code === cid.code)) {
        selectedCidsAtestado.push(cid);
        updateCIDChipsAtestado();
        updateCertText();
      }
      
      document.getElementById('cidSearchAtestado').value = '';
      document.getElementById('cidResultsAtestado').style.display = 'none';
    }
    
    function updateCIDChipsAtestado() {
      const container = document.getElementById('cidChipsAtestado');
      container.innerHTML = '';
      
      selectedCidsAtestado.forEach(cid => {
        const chip = document.createElement('div');
        chip.className = 'cid-chip';
        chip.innerHTML = `
          ${cid.code} - ${cid.description}
          <button onclick="removeCIDAtestado('${cid.code}')"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(chip);
      });
    }
    
    function removeCIDAtestado(code) {
      selectedCidsAtestado = selectedCidsAtestado.filter(item => item.code !== code);
      updateCIDChipsAtestado();
      updateCertText();
    }
    
    function saveCertificate() {
      const certText = document.getElementById('certReason').value;
      if (!certText) {
        alert('Selecione um modelo de atestado primeiro.');
        return;
      }
      
      localStorage.setItem('lastCertificate', certText);
      showAlert('Atestado salva com sucesso!', 'success');
    }
    
    function printCertificate() {
      const certText = document.getElementById('certReason').value;
      if (!certText) {
        alert('Selecione um modelo de atestado primeiro.');
        return;
      }
      
      const printContent = `
        <div style="padding: 30px; font-family: Arial; line-height: 1.6;">
          <div style="white-space: pre-wrap; font-size: 14px;">${certText}</div>
          <br><br><br>
          <div style="margin-top: 50px; text-align: center;">
            <p>_________________________________________</p>
            <p><strong>Dr. Silva</strong></p>
            <p>CRM: 123456</p>
            <p>Geriatria 360</p>
          </div>
        </div>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }
    
    // Calendário
    let currentDate = new Date();
    
    function initCalendar() {
      updateCalendar();
    }
    
    function updateCalendar() {
      const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                         "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
      
      document.getElementById('currentMonth').textContent = 
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
      
      const calendarDates = document.getElementById('calendarDates');
      calendarDates.innerHTML = '';
      
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      
      // Dias vazios no início
      for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'calendar-date';
        calendarDates.appendChild(emptyDiv);
      }
      
      // Dias do mês
      for (let i = 1; i <= lastDay.getDate(); i++) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'calendar-date';
        dateDiv.textContent = i;
        
        // Marcar data atual
        const today = new Date();
        if (i === today.getDate() && 
            currentDate.getMonth() === today.getMonth() && 
            currentDate.getFullYear() === today.getFullYear()) {
          dateDiv.classList.add('today');
        }
        
        dateDiv.addEventListener('click', () => selectDate(i));
        calendarDates.appendChild(dateDiv);
      }
    }
    
    function changeMonth(direction) {
      currentDate.setMonth(currentDate.getMonth() + direction);
      updateCalendar();
    }
    
    function selectDate(day) {
      // Remover seleção anterior
      document.querySelectorAll('.calendar-date.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Adicionar seleção atual
      const dates = document.querySelectorAll('.calendar-date');
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
      dates[firstDay + day - 1].classList.add('selected');
      
      alert(`Data selecionada: ${day}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`);
    }
    
    // Funções de debug
    function debugSistema() {
      const debugOutput = document.getElementById('debugOutput');
      let output = '<strong>=== DEBUG DO SISTEMA ===</strong><br>';
      
      output += `<strong>🩺 Current Appointment:</strong> ${JSON.stringify(currentAppointment, null, 2)}<br><br>`;
      
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes') || '[]');
      output += `<strong>👥 Pacientes (${pacientes.length}):</strong> ${JSON.stringify(pacientes, null, 2)}<br><br>`;
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos') || '[]');
      output += `<strong>📅 Agendamentos (${agendamentos.length}):</strong> ${JSON.stringify(agendamentos, null, 2)}<br><br>`;
      
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens') || '[]');
      output += `<strong>📊 Triagens (${triagens.length}):</strong> ${JSON.stringify(triagens, null, 2)}<br><br>`;
      
      debugOutput.innerHTML = output;
      
      // Também logar no console
      console.log('=== DEBUG DO SISTEMA ===');
      console.log('Current Appointment:', currentAppointment);
      console.log('Pacientes:', pacientes);
      console.log('Agendamentos:', agendamentos);
      console.log('Triagens:', triagens);
    }

    // Função de teste de integração
    function testarIntegracao() {
      console.log('=== TESTE DE INTEGRAÇÃO ===');
      
      const agendamentos = JSON.parse(localStorage.getItem('geriatria_agendamentos')) || [];
      const pacientes = JSON.parse(localStorage.getItem('geriatria_pacientes')) || [];
      const triagens = JSON.parse(localStorage.getItem('geriatria_triagens')) || [];
      
      console.log('Pacientes:', pacientes);
      console.log('Agendamentos:', agendamentos);
      console.log('Triagens:', triagens);
      
      // Verificar se há agendamentos com triagem
      agendamentos.forEach(ag => {
        const triagem = triagens.find(t => 
          t.agendamentoId === ag.id || 
          t.pacienteId == ag.pacienteId
        );
        console.log(`Agendamento ${ag.id} (${ag.pacienteNome}):`, {
          status: ag.status,
          temTriagem: !!triagem,
          triagem: triagem
        });
      });
      
      alert('Verifique o console (F12) para ver os resultados do teste.');
    }
    
    // Outras funções (placeholders)
    function saveEvolution() {
      showAlert('Evolução salva com sucesso!', 'success');
    }
    
    function generateAIReport() {
      showAlert('Laudo gerado pela IA com base nas informações fornecidas!', 'success');
    }
    
    function newDocument() {
      alert('Criando novo documento médico...');
    }
    
    function openDocument(type) {
      alert(`Abrindo documento: ${type}`);
    }
    
    function newAppointment() {
      alert('Abrindo formulário para novo agendamento...');
    }
  </script>
</body>
</html>
